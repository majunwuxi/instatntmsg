# 密码重置和超级用户功能指南

## 新增功能概述

### 1. 忘记密码功能
- 用户可以通过邮箱地址重置密码
- 发送包含重置链接的邮件
- 重置链接24小时内有效
- 专用的密码重置页面

### 2. 超级用户功能
- 系统自动创建管理员账户
- 用户名：`admin`
- 初始密码：通过环境变量 `ADMIN_PASSWORD` 配置
- 管理员账户无需邮箱验证即可登录

## 使用流程

### 忘记密码流程
1. **发起重置请求**：
   - 在登录页面点击"忘记密码？"
   - 输入注册时使用的邮箱地址
   - 点击"发送重置邮件"

2. **检查邮箱**：
   - 查收密码重置邮件
   - 点击邮件中的"重置密码"按钮
   - 或复制链接到浏览器打开

3. **重置密码**：
   - 在重置页面输入新密码（至少6位）
   - 确认新密码
   - 点击"重置密码"完成

4. **重新登录**：
   - 使用新密码登录系统

### 超级用户登录
- 用户名：`admin`
- 密码：通过环境变量 `ADMIN_PASSWORD` 配置
- 无需邮箱验证，可直接登录使用所有功能

### 管理员密码配置
1. **开发环境**：在 `.env.local` 中设置 `ADMIN_PASSWORD=your_password`
2. **生产环境**：必须设置强密码，否则系统拒绝启动
3. **安全建议**：使用至少12位的复杂密码

## 技术实现细节

### API端点
- `POST /api/auth/forgot-password` - 发起密码重置
- `POST /api/auth/reset-password` - 执行密码重置
- `GET /api/auth/reset-password?token=xxx` - 验证重置令牌

### 页面路由
- `/reset-password?token=xxx` - 密码重置页面

### 安全特性
- 密码使用SHA-256哈希存储
- 重置令牌使用UUID生成
- 重置链接24小时后自动过期
- 令牌使用后自动失效

### 邮件模板
- 专业的HTML邮件模板
- 包含重置链接和说明
- 安全提示和过期时间说明

## 环境配置

确保在 `.env.local` 中配置了以下变量：

```env
# Resend API配置（用于发送邮件）
RESEND_API_KEY=your_resend_api_key_here
FROM_EMAIL=noreply@yourdomain.com

# 可选：生产环境URL
NEXTAUTH_URL=https://yourdomain.com
```

## 日志记录

系统会记录以下密码相关操作：
- 密码重置请求
- 密码重置成功
- 管理员账户创建
- 登录成功/失败（包括密码错误）

## 安全注意事项

1. **生产环境建议**：
   - 使用bcrypt替代SHA-256进行密码哈希
   - 实施密码复杂度要求
   - 添加登录尝试次数限制
   - 使用HTTPS传输

2. **管理员账户**：
   - 首次登录后应立即修改默认密码
   - 考虑为管理员账户实施双因素认证

3. **重置令牌**：
   - 当前令牌24小时过期
   - 可根据安全需求调整过期时间
   - 令牌仅可使用一次

## 故障排除

### 邮件发送失败
- 检查RESEND_API_KEY是否正确配置
- 验证FROM_EMAIL域名是否在Resend中验证
- 查看服务器日志获取详细错误信息

### 重置链接无效
- 检查链接是否在24小时内使用
- 确认令牌是否已被使用过
- 验证URL中的token参数是否完整

### 管理员登录问题
- 确认用户名为`admin`（全小写）
- 确认已正确设置环境变量 `ADMIN_PASSWORD`
- 检查系统是否正确初始化管理员账户
- 开发环境默认密码为 `admin123`（如果未设置环境变量）